{% load sass_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    .NodeContainer {
      display: grid;
      gap: 5px;
      place-items: center center;
    }
    .Nodes button{
      all: unset;
      cursor: pointer;
    }
    
    
  </style>
  <link href="{% sass_src 'NodeApp/CSS/nodeModal.scss' %}" rel="stylesheet" type="text/css">
</head>
<body>

  <div class="NodeContainer">

  </div>
  <div class="nodeUploadModal hidden">
    <div class="modal_Overlay"></div>
    <div class="modal_Contents">
      <div class='Explain_Contents'>
        <p class='Node_Owner'></p>
        <p class='Node_Name'></p>
        <p class = 'Node_Discriptions'></p>
        <p class = 'Node_Create_Time'></p>
      </div>
      <div class='Low_Contents'>
        <div class='Upload_Contents'>
          <form method="POST" action="{% url 'node:create_node' %}" class="upload_Form" enctype="multipart/form-data">
            {% csrf_token %}
          <div class="hiddenInput">
            <input type = 'hidden' class="sendDataInput" type="text">
            <input type = 'hidden' class="sendDataInput" type="text">
            <input type = 'hidden' class="sendDataInput" type="text">
            <input type = 'hidden' class="sendDataInput" type="text" name="something4" >
            <input type = 'hidden' class="sendDataInput" type="text" name="something5" >
          </div>
          <div class="drop-zone">
            <!-- <img class = 'upload' src = '{% static "MainApp/picture/Upload.png" %}'><span class="drop-zone__prompt">파일을 드롭하세요</span></img> -->
            <input type="file" name="myFile" class="drop-zone__input" multiple>
            <input type='hidden' name='pk' value='{{The_file.Code}}' formenctype="multipart/form-data">
          </div>
          <input class="uploadBtn" type="submit" value="업로드하기">
          </form>

        </div>
        <!-- <div class='Download_Contents'>
          <img src = '{% static "MainApp/picture/Download.png" %}'>
        </div> -->
      </div>
      
        
    </div>
  </div>
  <script>
    const NodeContainer = document.querySelector(".NodeContainer");
    const globalDataArray = [];
    const init = async () =>{
      let location_Data = '{{li_location}}'.replaceAll("&#x27;", "")
      let data = await getNodeData();
      let locationData = await getLocationData(data, location_Data);
      await createGrid(data); // 그리드 만들기
      await createNodeBtn(data, locationData);
      await settingNodeDiv();
      await showUpModal();
    }
    const getNodeData = async () => {
      let json_data = '{{json}}'.replaceAll("&quot;", "\"");
      let json = JSON.parse(json_data);
      for(let i = 0; i<json.length; i++){
        globalDataArray.push(json[i]);
      }
      return await json
    }
    const getLocationData = async(data, location_Data) =>{
      let locationStr = location_Data;
      locationStr = locationStr.replaceAll("[", "");
      locationStr = locationStr.replaceAll("]", "");
      let locationArray = new Array;
      let splitStr = locationStr.split(",");
      for(let i = 0; i<splitStr.length/3; i++){
        locationArray.push({
          Column : Number(locationStr.split(",")[3*i].trim()), // 넘어오는게 column , row, pk 순임..
          Row : Number(locationStr.split(",")[3*i+1].trim()),
          Pk : locationStr.split(",")[3*i + 2].trim(),//숫자로하면 맨 앞에 0이 지워져서 문자열로
        })
      }
      for(let i = 0; i<data.length; i++){
        for(let k = 0; k<data.length; k++){
          if(locationArray[i].Pk == data[k].pk){
            locationArray[i].priviousCode = data[k].fields.previousCode
          }
        }
      }
      return locationArray
    }
    const createGrid = async(data) => {
      //최대 row, columns 숫자 넣기 grid 생성
      let gridRowWidth = '{{gridRowNum}}'.replaceAll("&#x27;", ""); // views에서 받은 값 
      let gridColumnHeight = '{{gridColumnNum}}'.replaceAll("&#x27;", ""); // views에서 받은 값 
      NodeContainer.style.setProperty('grid', `${gridRowWidth} / ${gridColumnHeight}`); // grid 선언

      //grid-template-areas 선언
      let rowNum = '{{num_of_row}}'; // view에서 받은 행 최대값
      let columnNum = '{{num_of_column}}'; // view에서 받은 열 최대값

      let gridTemplateAreas = []; // 가공 이전 배열
      let gridTemplateAreasArray = []; // 가공 후 문자열
      for(let i = 0; i<rowNum; i++){
        gridTemplateAreas.push(new Array());
        gridTemplateAreas[i].push('"'); // css 에 " ~~ " " ~~ " 형식으로 들어가는데 앞 " 을 담당
        for(let k = 0; k<columnNum; k++) {
          gridTemplateAreas[i].push(`R${i+1}C${k+1}`);
        } 
        gridTemplateAreasArray.push(gridTemplateAreas[i].join(" ")); // css 형식 맞추기 위한 변환
      }
      let gridNodeAreas = gridTemplateAreasArray.join(' " ').concat(' "'); // css 에 " ~~ " " ~~ " 형식으로 들어가는데 뒷부분 " 을 담당 및 변환
      NodeContainer.style.setProperty('grid-template-areas', `${gridNodeAreas}`)
            // // 언급된 이전코드 수에 따라 row 수 결정 
      // let mentionedPeiviousCodeForRows = [];
      // let previousCodeNum = 0;
      // for(let i = 0; i<data.length; i++){ // 하나만 업로드 되었을때도 포함하기 위해 i=0인  [null] 을 포함하였다
      //   mentionedPreviousCodeForRows.push(data[i].fields.previousCode);
      //   for(let j = 1; j<mentionedPreviousCodeForRows.length; j++){
      //     if(data[i].fields.previousCode == mentionedPreviousCodeForRows[j] && previousCodeNum == 0){
      //       previousCodeNum ++;
      //     } else if (data[i].fields.previousCode == mentionedPreviousCodeForRows[j] && previousCodeNum == 1 ){
      //       previousCodeNum = 0;
      //       delete mentionedPreviousCodeForRows[j];
      //     }
      //   }
      // }
      // let setMentionedPreviousCode = Array.from(new Set(mentionedPreviousCodeForRows))
      // console.log(setMentionedPreviousCode)
      // // previousCode 수 검증에 따른 column 숫자 결정
      // let dataArray = [];
      // let mentionedPreviousCodeForColumns = [];
      // for(let i = 0; i<data.length; i++){
      //   dataArray.unshift(data[i]);
      //   mentionedPreviousCodeForColumns.push(data[i].fields.previousCode); //column 사용을 위한 것
      // }
      // console.log(dataArray);
      // for(let i = 0; i<data.length; i++){
      //   let testarray = [];
      //   if(dataArray[i].fields.previousCode != null){
      //     for(let k = 0; k<data.length; k++){
      //       let test = dataArray[i].fields.previousCode;
      //       if(k != i){
      //         if(test == data[k].pk){
      //           testarray.push(dataArray[k].fields.previousCode);
      //         } else if (data[k].fields.previousCode == null) {
      //           break
      //         }
      //       } 
      //       test = dataArray[k].fields.previousCode;
      //     }
      //     // console.log(testarray);
      //   } 
      // }
      
      // //row column 변수
      // let rowNum = setMentionedPreviousCode.length - 1;
    }
    const createNodeBtn = async(data, locationData) => {
      //node data 받아올 것 
      for(let i = 0; i<data.length; i++){ // 노드 수 만큼
        let varObj = {
          "row" : locationData[i].Row,
          "column" : locationData[i].Column,
          "Pk" : locationData[i].Pk,
        };
        let btnDiv = document.createElement("div");
        let btn = document.createElement("button");
        let btnText = document.createTextNode(`${varObj.row}행 ${varObj.column}열 ${varObj.Pk}`);
        btn.appendChild(btnText);
        btn.setAttribute("onclick", "sendDataToModal(this);")
        btn.setAttribute("class", `${varObj.Pk}`)
        btnDiv.appendChild(btn);
        btnDiv.setAttribute("class", `R${varObj.row}C${varObj.column} Nodes`);// R1C1 
        NodeContainer.appendChild(btnDiv);
      }
    }
    
    const settingNodeDiv = async() => {
      // 해당클래스 찾아서 grid-area 선언해야한다이말이야
      const Nodes = document.querySelectorAll(".Nodes");
      for(let i = 0; i<Nodes.length; i++){
        let nodeLocation = Nodes[i].classList[0];
        Nodes[i].style.setProperty('grid-area', `${nodeLocation}`); // 위치 지정
      }
    }
    const showUpModal = async (data) => {
      const modalButton = document.querySelectorAll(".Nodes");
      const modal = document.querySelector(".nodeUploadModal");
      const overlay = modal.querySelector(".modal_Overlay");
      const toggleModal = () => {
        modal.classList.toggle("hidden");
      }
      overlay.addEventListener("click", toggleModal);
      for(let i = 0; i<modalButton.length; i++){
        modalButton[i].addEventListener("click", toggleModal);
      }
    }
    const sendDataToModal = (clickedValue) => {
      let regionalDataArray = globalDataArray.slice();
      console.log(regionalDataArray)
      let clickedValuePk = clickedValue.classList[0];
      let clickedNode = [];
      for(let i = 0; i<regionalDataArray.length; i++){
        if(clickedValuePk == regionalDataArray[i].pk){
          let fields = regionalDataArray[i].fields;
          let clickedNodeData = {
            'NodeComment' : fields.comment,
            'NodeCreatedDate' : fields.createdDate,
            'NodeDescription' : fields.desecription,
            'NodeFileObj' : fields.fileObj,
            'NodeName' : fields.nodeName,
            'NodeOwnerFileCode' : fields.ownerFCode,
            'NodeOwnerProjectCode' : fields.ownerPCode,
            'NodePreviousCode': fields.previousCode,
            'NodeOwner' : fields.whoIsOwner,
            'NodePk' : clickedValuePk,
          }
          clickedNode.push(clickedNodeData)
        }
      }
      // console.log(clickedNodeData.length)
      // // const sendDataInput = document.querySelector(".hiddenInput");
      // // for(let i = 0; regionalDataArray.length; i++){

      // // }
      // // console.log(sendDataInput)


    } 

    init();
  </script>
</body>
</html>