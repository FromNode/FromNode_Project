{% extends 'base.html' %}
{% load sass_tags %}
{% load static %}

{% block scss %}
  <link href="{% sass_src 'NodeApp/CSS/NodeListHtml.scss' %}" rel="stylesheet" type="text/css">
  <link href="{% sass_src 'NodeApp/CSS/nodeModal.scss' %}" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="{% sass_src 'NodeApp/CSS/comment.scss' %}" rel="stylesheet" type="text/css">

  <style>
    .NodeContainer {
      display: grid;
      gap: 0;
      place-items: center center;
    }
    .Nodes button{
      all: unset;
      cursor: pointer;
    }
  </style>
{% endblock %}


{% block content %}
  <div class = "NodeInfo">
    <p class ="Proj_Title">{{pro_name}}</p>
    <div class = 'UserList'>
    {% for user in proj_user %}
    <div class = 'User' style='width: 60px; height: 60px; border: 5px solid; border-color:{{user.Profile.user_color}}; border-radius: 50%;'>
    <img src='{{user.Profile.profile_image.url}}' style='width: 60px; height: 60px;'></img>
    </div>
    {% endfor %}
    </div>
  </div>
  <div class="NodeContainer">
  </div>

<!-- Node 클릭시 나오는 모달 (파일 업로드, 다운로드, 댓글 가능) -->
  <div class="nodeUploadModal hidden">
    <div class="modal_Overlay"></div>
    <div class="modal_Contents">
      <div class="Top_Contents">
        <label class="modal_title form-label">Upload Node</label>
        <!-- <input type="text" placeholder="파일 설명을 남겨주세요" class="upload_input"> -->
        <div class='Upload_Contents'>
          <form method="POST" action="{% url 'node:create_node' %}" class="upload_Form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="hiddenInput">
            </div>
            <div class="drop-zone">
              <span class="drop-zone__text ">파일을 끌어오거나 영역을 클릭해 업로드할 파일을 선택하세요</span>
              <br><br>
              <input type="file" name="uploadFile" class="drop-zone__input" multiple>
              <input type='hidden' name='pk' value='{{The_file.Code}}' formenctype="multipart/form-data">
            </div>
            <br>
            <input class="uploadBtn btn btn-primary" type="submit" value="업로드하기">
          </form>
        </div>
      </div>
      <div class='Low_Contents'>
        <!-- comment write p 태그 부분은 영역 push위해서 불가피하게 이렇게 작업 ! -->
        <!-- <div id="comment_write">
          <p id="test" class="tribute-demo-input" placeholder="Enter some text here" contenteditable="true" data-tribute="true">
          </p>
          <button id="cmt_but">Comment</button>
      </div> -->
      
            {% include "NodeApp/comment.html" %}
            
            <!-- <p id="test" class="tribute-demo-input" placeholder="Enter some text here" contenteditable="true"
            data-tribute="true"></p> -->
    
            <!-- <form method="post" class="post-form my-3">
              <div class="mb-3">
                <label for="comment" class="form-label">Write Comment</label>
              </div><br>
              {% csrf_token %}
              <div class="form-group">
                  <label for="comment">댓글내용</label>
                  <textarea class="form-control"name="content" id="content" 
                            rows="3">{{ form.content.value|default_if_none:'' }}</textarea>
              </div>
              <button type="submit" class="btn btn-primary">Submit</button>
            </form> -->
            <!-- end -->

        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block JS %}
  <script>


    const NodeContainer = document.querySelector(".NodeContainer");
    const globalDataArray = [];
    const init = async () =>{
      let location_Data = '{{li_location}}'.replaceAll("&#x27;", "")
      let data = await getNodeData();
      console.log(data)
      let locationData = await getLocationData(data, location_Data);
      await createGrid(data); // 그리드 만들기
      await createNodeBtn(data, locationData);
      await createGhostDiv();
      await settingNodeDiv();
      await showUpModal();
    }
    const getNodeData = async () => {
      let json_data = '{{json}}'.replaceAll("&quot;", "\"");
      let json = JSON.parse(json_data);
      for(let i = 0; i<json.length; i++){
        globalDataArray.push(json[i]);
      }
      return await json
    }
    const getLocationData = async(data, location_Data) =>{
      let locationStr = location_Data;
      locationStr = locationStr.replaceAll("[", "");
      locationStr = locationStr.replaceAll("]", "");
      let locationArray = new Array;
      let splitStr = locationStr.split(",");
      for(let i = 0; i<splitStr.length/3; i++){
        locationArray.push({
          Column : Number(locationStr.split(",")[3*i].trim()), // 넘어오는게 column , row, pk 순임..
          Row : Number(locationStr.split(",")[3*i+1].trim()),
          Pk : locationStr.split(",")[3*i + 2].trim(),//숫자로하면 맨 앞에 0이 지워져서 문자열로
        })
      }
      for(let i = 0; i<splitStr.length/3; i++){
        for(let k = 0; k<data.length; k++){
          target = data[k].pk
          if(locationArray[i].Pk == target){
            locationArray[i].priviousCode = data[k].fields.previousCode
          }
        }
      }
      return locationArray
    }
    const createGrid = async(data) => {
      //최대 row, columns 숫자 넣기 grid 생성
      let gridRowWidth = '{{gridRowNum}}'.replaceAll("&#x27;", ""); // views에서 받은 값 
      let gridColumnHeight = '{{gridColumnNum}}'.replaceAll("&#x27;", ""); // views에서 받은 값 
      NodeContainer.style.setProperty('grid', `${gridRowWidth} / ${gridColumnHeight}`); // grid 선언

      //grid-template-areas 선언
      let rowNum = '{{num_of_row}}'; // view에서 받은 행 최대값
      let columnNum = '{{num_of_column}}'; // view에서 받은 열 최대값

      let gridTemplateAreas = []; // 가공 이전 배열
      let gridTemplateAreasArray = []; // 가공 후 문자열
      for(let i = 0; i<rowNum; i++){
        gridTemplateAreas.push(new Array());
        gridTemplateAreas[i].push('"'); // css 에 " ~~ " " ~~ " 형식으로 들어가는데 앞 " 을 담당
        for(let k = 0; k<columnNum; k++) {
          gridTemplateAreas[i].push(`R${i+1}C${k+1}`);
        } 
        gridTemplateAreasArray.push(gridTemplateAreas[i].join(" ")); // css 형식 맞추기 위한 변환
      }
      let gridNodeAreas = gridTemplateAreasArray.join(' " ').concat(' "'); // css 에 " ~~ " " ~~ " 형식으로 들어가는데 뒷부분 " 을 담당 및 변환
      NodeContainer.style.setProperty('grid-template-areas', `${gridNodeAreas}`);
    }
    const createNodeBtn = async(data, locationData) => {
      //node data 받아올 것 
      for(let i = 0; i<locationData.length; i++){ // 노드 수 만큼
        let varObj = {
          "row" : locationData[i].Row,
          "column" : locationData[i].Column,
          "Pk" : locationData[i].Pk,
        };
        let btnDiv = document.createElement("div");
        let btn = document.createElement("button");
        let btnText = document.createTextNode(`${varObj.row}행 ${varObj.column}열 ${varObj.Pk}`);
        btn.appendChild(btnText);
        btn.setAttribute("onclick", "sendDataToModal(this);")
        btn.setAttribute("class", `${varObj.Pk} nodeBtn`)
        btn.setAttribute("id", `${varObj.Pk}`)
        btnDiv.appendChild(btn);
        btnDiv.setAttribute("class", `R${varObj.row}C${varObj.column} Nodes`);// R1C1
        btnDiv.style.setProperty('width','80%');
        btnDiv.style.setProperty('height','50%');
        btnDiv.style.setProperty('border',`4px solid {{user.Profile.user_color}}`);
        btnDiv.style.setProperty('border-radius',`30% 30%`);
        NodeContainer.appendChild(btnDiv);
      }
    }
    const createGhostDiv = async() => {
      const emptyArea = document.querySelectorAll(".Nodes");
      let areaArray = [];
      let maxNumArray1 = [];
      let maxNumArray2 = [];
      for(let i=0; i<emptyArea.length; i++){
        let columnNum = emptyArea[i].classList[0].slice(1,2);
        let rowNum = emptyArea[i].classList[0].slice(3);
        maxNumArray1.push(Number(columnNum));
        maxNumArray2.push(Number(rowNum));
        areaArray.push(`${columnNum}${rowNum}`)
      }
      let maxColumnNum = Math.max(...maxNumArray1)
      let maxRowNum = Math.max(...maxNumArray2)
      let emptyAreaArray = [];
      for(let i=1; i<maxColumnNum+1; i++){
        for(let k=1; k<maxRowNum+1; k++){
          if(areaArray.includes(`${i}${k}`) == false){
            emptyAreaArray.push(`${i}${k}`);
          }
        }
      }
      for(let i=0; i<emptyAreaArray.length; i++){
        let row = emptyAreaArray[i].slice(0,1);
        let column = emptyAreaArray[i].slice(1,2);

        let createDiv = document.createElement("div");
        createDiv.setAttribute("class", `R${row}C${column} emptyAreas`);
        createDiv.style.setProperty('width', '100px');
        createDiv.style.setProperty('height', '100px');
        createDiv.style.setProperty('grid-area', `R${row}C${column}`);
        NodeContainer.appendChild(createDiv);
      }
    }
    const settingNodeDiv = async() => {
      // 해당클래스 찾아서 grid-area 선언
      const Nodes = document.querySelectorAll(".Nodes");
      for(let i = 0; i<Nodes.length; i++){
        let nodeLocation = Nodes[i].classList[0];
        Nodes[i].style.setProperty('grid-area', `${nodeLocation}`); // 위치 지정
      }
    }
    const showUpModal = async (data) => {
      const modalButton = document.querySelectorAll(".Nodes");
      const modal = document.querySelector(".nodeUploadModal");
      const overlay = modal.querySelector(".modal_Overlay");
      const toggleModal = () => {
        modal.classList.toggle("hidden");
      }
      overlay.addEventListener("click", toggleModal);
      for(let i = 0; i<modalButton.length; i++){
        modalButton[i].addEventListener("click", toggleModal);
      }
    }
    const sendDataToModal = async (clickedValue) => {
      let clickedBtn = clickedValue;
      let btnData = await searchDataSameToClickedBtnData(clickedBtn);
      await sendInputContents(btnData);
    }
    const searchDataSameToClickedBtnData = async (clickedBtn) => {
      let regionalDataArray = globalDataArray.slice();
      let clickedValuePk = clickedBtn.classList[0];
      let clickedNode = [];
      for(let i = 0; i<regionalDataArray.length; i++){
        if(clickedValuePk == regionalDataArray[i].pk){
          let fields = regionalDataArray[i].fields;
          let clickedNodeData = {
            'NodeComment' : fields.comment,
            'NodeCreatedDate' : fields.createdDate,
            'NodeDescription' : fields.desecription,
            'NodeFileObj' : fields.fileObj,
            'NodeName' : fields.nodeName,
            'NodeOwnerFileCode' : fields.ownerFCode,
            'NodeOwnerProjectCode' : fields.ownerPCode,
            'NodePreviousCode': fields.previousCode,
            'NodeOwner' : fields.whoIsOwner,
            'NodePk' : clickedValuePk,
          }
          
          nowCommentPK = clickedNodeData['NodePk']; 


          let comment_object = [
            {% for com in comment_data %}
              {
                node_code: "{{ com.node_code }}",
                content: "{{ com.content }}",
                author: "{{ com.author }}",
                author_img: "{{ com.author_img_url }}",
                who_is_mentioned: "{{ com.who_is_mentioned }}",
                create_date: "{{ com.created_date }}"
              },
            {% endfor %}
          ]

          var comment_array = [];
          // 불러온 comment_object를 for문으로 순회하여 현재 클릭된 Node PK(nowCommentPK)와 동일한 node_code를
          // 가진 코멘트 정보만 comment_array 배열에 push
          for(idx in comment_object) {
            if(nowCommentPK == comment_object[idx]['node_code']) {
              comment_array.push(comment_object[idx]);
            }
          }
          comment_array.reverse();
          // comment data를 html로 쏴주자

          const clicked_node_pk = nowCommentPK;
          const comment_write_box = document.getElementById('test');
          comment_write_box.innerText = "";
          const comment_write_but = document.getElementById('cmt_but'); 
          comment_write_but.setAttribute("class", `${clicked_node_pk}`);         
          const comment_container = document.getElementById('comment_body');
          comment_container.innerHTML = "";
          // const profile_image_part = document.getElementById('profile_part');
          // const author_name = document.getElementsById('author_name');
          // const cmt_created_date = document.getElementsById('created_date');

          for(let i=0; i<comment_array.length; i++){
            let commentObj= {
              "node_code": comment_array[i]['node_code'],
              "author_img" : comment_array[i]['author_img'],
              "author" : comment_array[i]['author'],
              "content" : comment_array[i]['content'],
              "created_date" : comment_array[i]['create_date'],
              "who_is_mentioned" :  comment_array[i]['who_is_mentioned'],
            };
            // let author_img = comment_array[i]['author_img'];
            // let author = comment_array[i]['author'];
            // let content = comment_array[i]['content'];
            // let created_date = comment_array[i]['create_date'];
            // let who_is_mentioned = comment_array[i]['who_is_mentioned'];
            // -- profile image

            let each_comment = document.createElement("div");
            each_comment.setAttribute("class", 'each_comment');
            comment_container.appendChild(each_comment);

            let profile_part = document.createElement("div");
            profile_part.setAttribute("class", 'profile_part');
            each_comment.appendChild(profile_part);

            let prof_img = document.createElement("img");
            prof_img.setAttribute("class", 'img-circle img-sm');
            prof_img.setAttribute("alt", 'Profile picture');
            prof_img.setAttribute("src", `${commentObj.author_img}`);
            profile_part.appendChild(prof_img);

            let comment_text_block = document.createElement("div");
            comment_text_block.setAttribute("class", 'comment_text_block');
            each_comment.appendChild(comment_text_block);

            let cmt_top = document.createElement("div");
            cmt_top.setAttribute("class", 'cmt_top');
            comment_text_block.appendChild(cmt_top);

            let author_name = document.createElement("p");
            author_name.setAttribute("class", 'cmt_block author_name');
            author_name.innerHTML = `${commentObj.author}`;
            cmt_top.appendChild(author_name);

            let created_date = document.createElement("p");
            author_name.setAttribute("class", 'cmt_block created_date');
            author_name.innerHTML = `${commentObj.created_date}` + "  "+ `${commentObj.node_code}`;
            cmt_top.appendChild(created_date);
                        
            let cmt_bottom = document.createElement("div");
            cmt_bottom.setAttribute("class", 'cmt_bottom');
            comment_text_block.appendChild(cmt_bottom);
            
            let who_is_mentioned = document.createElement("i");
            who_is_mentioned.setAttribute("class", 'cmt_text_block who_is_mentioned');
            who_is_mentioned.innerHTML = `${commentObj.who_is_mentioned}`;
            cmt_bottom.appendChild(who_is_mentioned);
            
            let cmt_text = document.createElement("p");
            cmt_text.setAttribute("class", 'cmt_text_block cmt_text');
            cmt_text.innerHTML = `${commentObj.content}`;
            cmt_bottom.appendChild(cmt_text);



          }


          // console.log(nowCommentPK);
          // $.ajax({
          //   url: "{% url 'node:load_comment' %}",
          //   type: 'POST',
          //   data:{'node_pk':nowCommentPK},
          //   success: function(data){
          //     console.log(data.keys);

          //   },
          //   error: function(e){
          //     console.log("node comment load error");
          //   }
          // })



          //from 재훈재훈

          // 현재 클릭된 Node의 Primary Key를 변수로 저장
          // nowCommentPK = clickedNodeData['NodePk']; 
          // views.py에서 context로 넘어온 object중 Node_Comment Model에 해당하는 comments를 불러옴
          // 단순히 for문으로 comments를 불러오면 문법으로 인한 오류가 나므로, JS에서 사용하는 Json과 동일한
          // 형태로 재구조화함
          // let comment_object = []
          //   {% for com in comments %}
          //     {
          //       node_code: "{{ com.node_code }}",
          //       content: "{{ com.content }}",
          //       author: "{{ com.author_comment }}",
          //       author_img: "{{ com.author_comment.username }}",
          //       create_date: "{{ com.create_date }}"
          //     },
          //     {% endfor %}
          // ]
          // 위에 코드를 아래처럼 바꾼거에요 !
          // let c_obj = "{{test_comments}}".replace(/&quot;/g, "\"");
          // var comment_object = JSON.parse(c_obj);


          // console.log("comment_object들은?? \n" + comment_object)
          // nowCommentPK = String(nowCommentPK);
          // var verbatimeA = "{% verbatim %}";
          // var nowCommentIF_A = "{% for i in comments %}";
          // var nowCommentIF_B = "{% if i.node_code_id == " + nowCommentPK + " %}";
          // var nowCommentIF_C = "{{ i.content }}<br>";
          // var nowCommentIF_D = "{% endif %}";
          // var nowCommentIF_E = "{% endfor %}";
          // var verbatimeB = "{% endverbatim %}";

          // var nowCommentState = nowCommentIF_A + 
          //                       nowCommentIF_B + 
          //                       nowCommentIF_C + 
          //                       nowCommentIF_D + 
          //                       nowCommentIF_E;
          // let nowCommentIF = "{% if i.node_code_id == '61102394' %} {{ i.content }}<br> {% endif %}";
          // var nodeCommentInnerHTML = document.getElementById("nodeCodeForComment");
          // nodeCommentInnerHTML.innerHTML = nowCommentState;

          // 클릭된 Node에 해당하는 코멘트만 담기 위한 comment_array 배열 선언
          // var comment_array = [];
          // 불러온 comment_object를 for문으로 순회하여 현재 클릭된 Node PK(nowCommentPK)와 동일한 node_code를
          // 가진 코멘트 정보만 comment_array 배열에 push
          // for(idx in comment_object) {
          //   if(nowCommentPK == comment_object[idx]['node_code']) {
          //     comment_array.push(comment_object[idx]);
          //   }
          // }
          // InnerHTML을 사용하여 comment_array 데이터를 차례로 HTML에 전달 --> 2021-02-12 12:18 기준 필요 없어짐 !!          
          clickedNode.push(clickedNodeData)
        }

      }
      return clickedNode
    }
    const sendInputContents = async (btnData) => {
      console.log(btnData);
        const sendDataInput = document.querySelector(".hiddenInput");
        const dataLength = Object.keys(btnData[0]).length;
        for(let i = 0; i<dataLength; i++){
          let objectKeys = Object.keys(btnData[0])[i];
          let objectValues = Object.values(btnData[0])[i];
          let createInput = document.createElement("input");
          createInput.setAttribute("type", "hidden");
          createInput.setAttribute("class", "sendDataInput");
          createInput.setAttribute("name", `${objectKeys}`);
          createInput.setAttribute("value", `${objectValues}`);
          sendDataInput.appendChild(createInput);
      }
      // modal에 해당 node의 댓글 data ajax로 받아오기

    } 

    init();

    
  </script>

  <script src="{% static 'NodeApp/JS/Upload.js' %}"></script>
  {% endblock %}